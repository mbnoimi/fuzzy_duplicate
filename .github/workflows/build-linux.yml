name: Build Linux Packages

on:
  push:
    branches: [ main, master, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.0'
        channel: 'stable'
    
    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
        sudo apt-get install -y imagemagick
    
    - name: Clean and recreate Linux platform
      run: |
        flutter clean
        rm -rf build linux pubspec.lock .dart_tool
        flutter create --platforms linux .
    
    - name: Get Flutter dependencies
      run: flutter pub get
    
    - name: Generate icons and update app info
      run: |
        dart run flutter_launcher_icons
        dart tools/update_app_info.dart
    
    - name: Extract version info
      id: version
      run: |
        LAUNCHER_NAME=$(grep "launcherName" lib/app_info.dart | awk -F"'" '{print $2}' | tr ' ' '_')
        NAME=$(grep "name" lib/app_info.dart | awk -F"'" '{print $2}' | tr ' ' '_')
        VERSION=$(grep "version" lib/app_info.dart | awk -F"'" '{print $2}')
        DESCRIPTION=$(grep "description" lib/app_info.dart | awk -F"'" '{print $2}')
        LAUNCHER_NAME_PRETTY=$(grep "launcherName" lib/app_info.dart | awk -F"'" '{print $2}')
        echo "launcher_name=$LAUNCHER_NAME" >> $GITHUB_OUTPUT
        echo "name=$NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
        echo "launcher_name_pretty=$LAUNCHER_NAME_PRETTY" >> $GITHUB_OUTPUT
    
    - name: Build Linux executable
      run: flutter build linux --release
    
    - name: Create directories
      run: |
        mkdir -p distro
        mkdir -p .build_tmp
    
    - name: Create tarball
      run: |
        LAUNCHER_NAME="${{ steps.version.outputs.launcher_name }}"
        VERSION="${{ steps.version.outputs.version }}"
        NAME="${{ steps.version.outputs.name }}"
        mv build/linux/x64/release/bundle/ ".build_tmp/${LAUNCHER_NAME}-${VERSION}"
        chmod +x ".build_tmp/${LAUNCHER_NAME}-${VERSION}/${NAME}"
        tar -cavf "distro/${LAUNCHER_NAME}_linux.tar.gz" -C ".build_tmp" "${LAUNCHER_NAME}-${VERSION}" --use-compress-program="gzip -9"
    
    - name: Create AppImage
      run: |
        LAUNCHER_NAME="${{ steps.version.outputs.launcher_name }}"
        VERSION="${{ steps.version.outputs.version }}"
        NAME="${{ steps.version.outputs.name }}"
        DESCRIPTION="${{ steps.version.outputs.description }}"
        LAUNCHER_NAME_PRETTY="${{ steps.version.outputs.launcher_name_pretty }}"
        
        APPDIR=".build_tmp/${LAUNCHER_NAME}-${VERSION}.AppDir"
        mkdir -p "${APPDIR}/usr/bin"
        mkdir -p "${APPDIR}/usr/share/applications"
        mkdir -p "${APPDIR}/usr/share/icons/hicolor/256x256/apps"
        mkdir -p "${APPDIR}/usr/share/metainfo"
        
        cp -r ".build_tmp/${LAUNCHER_NAME}-${VERSION}/"* "${APPDIR}/usr/bin/"
        
        # Create .desktop file
        printf '%s\n' '[Desktop Entry]' "Name=${LAUNCHER_NAME_PRETTY}" "Comment=${DESCRIPTION}" "Exec=${NAME}" "Icon=${NAME}" 'Type=Application' 'Categories=System;FileTools;Utility;' 'Terminal=false' 'StartupNotify=true' "StartupWMClass=${NAME}" 'Keywords=duplicate;file;finder;fuzzy;similar;search;system;utility;' 'MimeType=inode/directory;' > "${APPDIR}/usr/share/applications/${NAME}.desktop"
        
        # Copy icon
        if [ -f "assets/icons/icon.png" ]; then
            cp "assets/icons/icon.png" "${APPDIR}/usr/share/icons/hicolor/256x256/apps/${NAME}.png"
            cp "assets/icons/icon.png" "${APPDIR}/${NAME}.png"
        elif command -v convert &> /dev/null && [ -f "assets/icons/logo.svg" ]; then
            convert -background none "assets/icons/logo.svg" -resize 256x256 "${APPDIR}/usr/share/icons/hicolor/256x256/apps/${NAME}.png"
            cp "${APPDIR}/usr/share/icons/hicolor/256x256/apps/${NAME}.png" "${APPDIR}/${NAME}.png"
        fi
        
        # Create AppStream metadata using printf to avoid YAML parsing issues
        APP_ID="io.github.${NAME}"
        HOMEPAGE_URL="https://github.com/mbnoimi/${NAME}"
        METAINFO_FILE="${APPDIR}/usr/share/metainfo/${APP_ID}.metainfo.xml"
        
        printf '<?xml version="1.0" encoding="UTF-8"?>\n' > "${METAINFO_FILE}"
        printf '<component type="desktop-application">\n' >> "${METAINFO_FILE}"
        printf '  <id>%s</id>\n' "${APP_ID}" >> "${METAINFO_FILE}"
        printf '  <metadata_license>MIT</metadata_license>\n' >> "${METAINFO_FILE}"
        printf '  <project_license>MIT</project_license>\n' >> "${METAINFO_FILE}"
        printf '  <name>%s</name>\n' "${LAUNCHER_NAME_PRETTY}" >> "${METAINFO_FILE}"
        printf '  <summary>%s</summary>\n' "${DESCRIPTION}" >> "${METAINFO_FILE}"
        printf '  <description>\n' >> "${METAINFO_FILE}"
        printf '    <p>%s is a powerful tool to find and manage duplicate files using fuzzy matching algorithms.</p>\n' "${LAUNCHER_NAME_PRETTY}" >> "${METAINFO_FILE}"
        printf '    <p>Features include:</p>\n' >> "${METAINFO_FILE}"
        printf '    <ul>\n' >> "${METAINFO_FILE}"
        printf '      <li>GUI and CLI interfaces</li>\n' >> "${METAINFO_FILE}"
        printf '      <li>Fuzzy matching for similar files</li>\n' >> "${METAINFO_FILE}"
        printf '      <li>Duplicate detection and management</li>\n' >> "${METAINFO_FILE}"
        printf '    </ul>\n' >> "${METAINFO_FILE}"
        printf '  </description>\n' >> "${METAINFO_FILE}"
        printf '  <developer_name>mbnoimi</developer_name>\n' >> "${METAINFO_FILE}"
        printf '  <url type="homepage">%s</url>\n' "${HOMEPAGE_URL}" >> "${METAINFO_FILE}"
        printf '  <url type="bugtracker">%s/issues</url>\n' "${HOMEPAGE_URL}" >> "${METAINFO_FILE}"
        printf '  <categories>\n' >> "${METAINFO_FILE}"
        printf '    <category>System</category>\n' >> "${METAINFO_FILE}"
        printf '    <category>FileTools</category>\n' >> "${METAINFO_FILE}"
        printf '    <category>Utility</category>\n' >> "${METAINFO_FILE}"
        printf '  </categories>\n' >> "${METAINFO_FILE}"
        printf '  <provides>\n' >> "${METAINFO_FILE}"
        printf '    <binary>%s</binary>\n' "${NAME}" >> "${METAINFO_FILE}"
        printf '  </provides>\n' >> "${METAINFO_FILE}"
        printf '  <launchable type="desktop-id">%s.desktop</launchable>\n' "${NAME}" >> "${METAINFO_FILE}"
        printf '  <content_rating type="oars-1.1" />\n' >> "${METAINFO_FILE}"
        printf '</component>\n' >> "${METAINFO_FILE}"
        
        # Create AppRun script
        echo '#!/bin/bash' > "${APPDIR}/AppRun"
        echo 'APPDIR="$(dirname "$(readlink -f "$0")")"' >> "${APPDIR}/AppRun"
        echo 'export LD_LIBRARY_PATH="${APPDIR}/usr/bin/lib:${LD_LIBRARY_PATH}"' >> "${APPDIR}/AppRun"
        echo '' >> "${APPDIR}/AppRun"
        echo "exec \"\${APPDIR}/usr/bin/${NAME}\" \"\$@\"" >> "${APPDIR}/AppRun"
        chmod +x "${APPDIR}/AppRun"
        
        # Create symlinks
        ln -sf "usr/share/applications/${NAME}.desktop" "${APPDIR}/${NAME}.desktop"
        if [ -f "${APPDIR}/${NAME}.png" ]; then
            ln -sf "${NAME}.png" "${APPDIR}/.DirIcon"
        fi
        
        # Download appimagetool
        wget -q -O "/tmp/appimagetool-x86_64.AppImage" "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x "/tmp/appimagetool-x86_64.AppImage"
        
        # Build AppImage
        ARCH=x86_64 "/tmp/appimagetool-x86_64.AppImage" "${APPDIR}" "distro/${LAUNCHER_NAME}-${VERSION}-x86_64.AppImage"
        chmod +x "distro/${LAUNCHER_NAME}-${VERSION}-x86_64.AppImage"
    
    - name: Cleanup build directory
      run: rm -rf .build_tmp
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build-${{ steps.version.outputs.version }}
        path: |
          distro/*.tar.gz
          distro/*.AppImage
        retention-days: 30
    
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          distro/*.tar.gz
          distro/*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
